apiVersion: pgv2.percona.com/v2
kind: PerconaPGCluster
metadata:
  name: cxs-pg
spec:
  crVersion: 2.3.1
  users:
    - name: postgres
    - name: cxs-pg
      options: "SUPERUSER"
      databases:
        - ssp
    - name: aiflow-db
      databases:
        - airflow
    - name: n8n-db
      databases:
        - n8n
    - name: convoy-db
      databases:
        - convoy
    - name: grafana-db
      databases:
        - grafana
    - name: grafana
      databases:
        - grafana
  image: percona/percona-postgresql-operator:2.3.1-ppg16-postgres
  imagePullPolicy: Always
  postgresVersion: 16
  instances:
    - name: instance1
      replicas: 3

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    postgres-operator.crunchydata.com/data: postgres
                topologyKey: kubernetes.io/hostname
      dataVolumeClaimSpec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 64Gi

  proxy:
    pgBouncer:
      replicas: 3
      image: percona/percona-postgresql-operator:2.3.1-ppg16-pgbouncer
      exposeSuperusers: true
      config:
        global:
          max_client_conn: "200"
          default_pool_size: "50"


      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    postgres-operator.crunchydata.com/role: pgbouncer
                topologyKey: kubernetes.io/hostname

  backups:
    pgbackrest:
      image: percona/percona-postgresql-operator:2.3.1-ppg16-pgbackrest
      global:
        repo1-retention-full: "8"
        repo1-retention-full-type: count
      repoHost:
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 1
                podAffinityTerm:
                  labelSelector:
                    matchLabels:
                      postgres-operator.crunchydata.com/data: pgbackrest
                  topologyKey: kubernetes.io/hostname
      manual:
        repoName: repo1
        options:
          - --type=full
      repos:
        - name: repo1
          schedules:
            full: "0 0 * * 6"
            differential: "0 0 * * 0-5"
          volume:
            volumeClaimSpec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 64Gi

  pmm:
    enabled: false
    image: percona/pmm-client:2.41.0
    secret: cluster1-pmm-secret
    serverHost: monitoring-service
  patroni:
    dynamicConfiguration:
      postgresql:
        parameters:
          max_connections: 300
