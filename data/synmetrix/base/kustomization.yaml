apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: synmetrix

resources:
  # Core resources
  - manifests/serviceaccount.yaml
  - manifests/ingress.yaml

  # Persistent Volume Claims
  - manifests/pvcs/cubejs-pvc.yaml
  - manifests/pvcs/cubestore-pvc.yaml
  - manifests/pvcs/hasura-pvc.yaml
  - manifests/pvcs/minio-pvc.yaml

  # Services
  - manifests/services/actions-service.yaml
  - manifests/services/client-service.yaml
  - manifests/services/cubejs-service.yaml
  - manifests/services/cubestore-service.yaml
  - manifests/services/hasura-service.yaml
  - manifests/services/mailhog-service.yaml
  - manifests/services/mailhog-web-service.yaml
  - manifests/services/minio-service.yaml

  # Deployments
  - manifests/deployments/actions-deployment.yaml
  - manifests/deployments/client-deployment.yaml
  - manifests/deployments/cubejs-deployment.yaml
  - manifests/deployments/cubestore-deployment.yaml
  - manifests/deployments/hasura-deployment.yaml
  - manifests/deployments/mailhog-deployment.yaml
  - manifests/deployments/minio-deployment.yaml


images:
  - name: quicklookup/synmetrix-client
    newTag: latest
  - name: quicklookup/synmetrix-actions
    newTag: latest
  - name: quicklookup/synmetrix-cube
    newTag: latest 

configMapGenerator:
  - name: synmetrix-config
    literals:
      - CUBEJS_CACHE_TYPE=redis
      - CUBEJS_CUBESTORE_HOST=cubestore
      - CUBEJS_CUBESTORE_PORT=3030
      - CUBEJS_DB_CLICKHOUSE_READONLY="true"
      - CUBEJS_DB_PORT=5432
      - CUBEJS_DB_TYPE=postgres
      - CUBEJS_NATIVE_INTERNAL_DEBUG=true
      - CUBEJS_PG_SQL_PORT=15432
      - CUBEJS_SQL_PORT=13306
      - CUBEJS_TELEMETRY=false
      - CUBEJS_URL=http://synmetrix-cubejs:4000

      - CUBESQL_DEBUG_QTRACE=true
      - CUBESTORE_VERSION=v1.2.3
      
      - DEBUG_LOG=true
      
      - HASURA_ENDPOINT=http://synmetrix-hasura:8080/v1/graphql
      
      - LOG_LEVEL=debug
      - NODE_ENV=production
      - SMTP_HOST=mailhog-smtp.mailhog.svc.cluster.local
      - SMTP_PORT=1025

    

secretGenerator:

  - name: synmetrix-secrets
    literals:
      - POSTGRES_DB=synmetrix
      - REDIS_URL=redis://redis-master.data.svc.cluster.local:6379
    envs:
      - synmetrix-secrets.env

labels:
- pairs:
    app.kubernetes.io/part-of: synmetrix

# Common annotations
commonAnnotations:
  kustomize.config.k8s.io/needs-hash-suffix: "true"
