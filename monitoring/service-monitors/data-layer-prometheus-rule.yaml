apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: data-layer-alerts
  namespace: cattle-monitoring-system
  labels:
    release: rancher-monitoring
spec:
  groups:
    - name: data-layer-critical
      interval: 30s
      rules:
        # CRITICAL: Drive failure alerts (RAID-0 = zero fault tolerance)
        - alert: DataLayerDriveFailure
          expr: smart_device_health{node_role="data-layer"} == 0
          for: 0m
          labels:
            severity: critical
            team: infrastructure
            component: storage
          annotations:
            summary: "CRITICAL: NVMe drive failure detected on {{ $labels.instance }}"
            description: "Drive {{ $labels.device }} on {{ $labels.instance }} has failed SMART health check. RAID-0 setup means complete node failure imminent."
            runbook_url: "https://docs.internal/runbooks/data-layer-drive-failure"
            
        # CRITICAL: High drive temperature  
        - alert: DataLayerDriveTemperature
          expr: smart_temperature_celsius{node_role="data-layer"} > 70
          for: 5m
          labels:
            severity: critical
            team: infrastructure
            component: storage
          annotations:
            summary: "Drive temperature critical on {{ $labels.instance }}"
            description: "Drive {{ $labels.device }} temperature is {{ $value }}°C (threshold: 70°C)"
            
        # CRITICAL: Storage capacity - prevent another MinIO crisis
        - alert: DataLayerStorageCritical
          expr: (loop_device_usage_percent{node_role="data-layer"} > 90)
          for: 2m
          labels:
            severity: critical
            team: infrastructure
            component: storage
          annotations:
            summary: "Storage critically full on {{ $labels.instance }}"
            description: "Loop device {{ $labels.device }} is {{ $value }}% full (threshold: 90%)"
            
        # WARNING: Storage capacity planning
        - alert: DataLayerStorageWarning  
          expr: (loop_device_usage_percent{node_role="data-layer"} > 80)
          for: 5m
          labels:
            severity: warning
            team: infrastructure
            component: storage
          annotations:
            summary: "Storage usage high on {{ $labels.instance }}"
            description: "Loop device {{ $labels.device }} is {{ $value }}% full (threshold: 80%)"
            
        # CRITICAL: Node unreachable
        - alert: DataLayerNodeDown
          expr: up{job="data-layer-nodes"} == 0
          for: 1m
          labels:
            severity: critical
            team: infrastructure
            component: compute
          annotations:
            summary: "Data layer node {{ $labels.instance }} is unreachable"
            description: "Cannot scrape metrics from {{ $labels.instance }}. Node may be down or network issues."
            
        # CRITICAL: MinIO cluster offline  
        - alert: DataLayerMinIOClusterOffline
          expr: minio_cluster_nodes_offline_total{cluster="cxs-data-layer"} > 0
          for: 1m
          labels:
            severity: critical
            team: infrastructure
            component: storage
          annotations:
            summary: "MinIO cluster has {{ $value }} nodes offline"
            description: "MinIO cluster has {{ $value }} offline nodes. Distributed storage may be degraded."
            
        # CRITICAL: MinIO drive offline
        - alert: DataLayerMinIODriveOffline
          expr: minio_cluster_drives_offline_total{cluster="cxs-data-layer"} > 0
          for: 1m
          labels:
            severity: critical
            team: infrastructure  
            component: storage
          annotations:
            summary: "MinIO has {{ $value }} drives offline"
            description: "MinIO cluster has {{ $value }} offline drives. Data redundancy may be compromised."
            
        # WARNING: MinIO high disk usage
        - alert: DataLayerMinIODiskUsageHigh
          expr: (minio_cluster_usage_total_bytes{cluster="cxs-data-layer"} / minio_cluster_capacity_raw_total_bytes{cluster="cxs-data-layer"}) * 100 > 85
          for: 5m
          labels:
            severity: warning
            team: infrastructure
            component: storage
          annotations:
            summary: "MinIO disk usage is {{ $value }}%"
            description: "MinIO cluster disk usage is {{ $value }}% (threshold: 85%). Consider expanding storage."
            
        # CRITICAL: MinIO disk usage critical
        - alert: DataLayerMinIODiskUsageCritical
          expr: (minio_cluster_usage_total_bytes{cluster="cxs-data-layer"} / minio_cluster_capacity_raw_total_bytes{cluster="cxs-data-layer"}) * 100 > 95
          for: 2m
          labels:
            severity: critical
            team: infrastructure
            component: storage
          annotations:
            summary: "MinIO disk usage critical at {{ $value }}%"
            description: "MinIO cluster disk usage is {{ $value }}% (threshold: 95%). Storage expansion urgent!"
            
        # CRITICAL: RAID array degraded (if using mdadm)
        - alert: DataLayerRAIDDegraded
          expr: raid_array_status{node_role="data-layer"} == 0
          for: 0m
          labels:
            severity: critical
            team: infrastructure
            component: storage
          annotations:
            summary: "RAID array degraded on {{ $labels.instance }}"
            description: "RAID array on {{ $labels.instance }} is degraded or failed"
            
        # WARNING: High drive wear (SSD/NVMe)
        - alert: DataLayerDriveWear
          expr: smart_wear_level_percent{node_role="data-layer"} < 10
          for: 10m
          labels:
            severity: warning
            team: infrastructure
            component: storage
          annotations:
            summary: "Drive wear level low on {{ $labels.instance }}"
            description: "Drive {{ $labels.device }} wear level is {{ $value }}% (threshold: 10%)"
            
        # CRITICAL: Reallocated sectors detected
        - alert: DataLayerReallocatedSectors
          expr: smart_reallocated_sectors_count{node_role="data-layer"} > 0
          for: 0m
          labels:
            severity: critical
            team: infrastructure
            component: storage
          annotations:
            summary: "Reallocated sectors detected on {{ $labels.instance }}"
            description: "Drive {{ $labels.device }} has {{ $value }} reallocated sectors. Drive may be failing."